#!/usr/bin/env node

var gulp = require('gulp');
var path = require('path');
var gutil = require('gulp-util');
var PluginError = require('gulp-util').PluginError;
var exec = require('child_process').exec;
var gutil = require('gulp-util');
var colors = require('colors');
var eslint = require('gulp-eslint');
var Promise = require('bluebird');
var process = require('process');
var Config = path.join(process.cwd(), './.eslintrc');
// var eslintrc = require(Config);
if(!Config){
  console.log("PLEASE CREATE .eslintrc file FITRT".red);
  throw new PluginError("error", {message: 'æ²¡æœ‰æ‰¾åˆ°eslintæ–‡ä»¶'})
}

function mltLint (options) {
  this.options = options;
  this.flag = 0;
}

mltLint.prototype = {
  constructor :  mltLint,
  test : function (results, arrNum) {
    var me = this;
    if(results.messages.length != 0){
      var messages = results.messages;
      console.log(results.filePath.green);
      for(var i = 0; i < messages.length; i++){
        if(me.numInBox(messages[i].line, arrNum)){
          me.flag++;
          console.log('errorline and errcolum     '.red + messages[i].line + 'è¡Œ' + messages[i].column + 'åˆ—' +
            '\nerrorcode                  '.red + messages[i].source.blue + '\nerrormessage               ' + messages[i].message.blue + '\n');
        }
      }
    }
  },

  getEsLintResult : function (errorlineNb) {
    var me = this;
    return new Promise(function (resolve, reject) {
      var filePath = errorlineNb.filePath,  arr = errorlineNb.errLine;
        gulp.src(filePath)  //
          .pipe(eslint())     // jsä»£ç æ£€æŸ¥
          .pipe(eslint.result(function (results) {
              var arrNum = arr;
              me.test(results, arrNum);
              resolve("checkout");
          }));
    })
  },
  numInBox : function (num, arr) {
    var flag = false;
      for(var i = 0; i < arr.length; i++){
        var arrList = arr[i];
        if(num > arrList[0] && num < arrList[1]){
          flag = true;
        }
      }
      return flag;
  },


  lintChain : function () {
    var me = this;
    return new Promise(function (resolve, reject) {
      var args = "git diff HEAD";
      var shell = exec(args, function (error,  stdout, stderr) {
          resolve(stdout);
      });
    }).then(function (stdout) {
      return new Promise (function (resolve, reject) {
        var errLineNb = [];
        //å°†æ–‡ä»¶å’Œè¡Œæ•°ä»Žè¿”å›žå€¼ä¸­å–å‡ºæ¥çš„æ­£åˆ™
        var regx = /\+\s[b][\/][a-z/]*[\.][j][s]|[@][@]\s-[0-9]+\,[0-9]+\s\+[0-9]+\,[0-9]+/ig
        //å°†æ–‡ä»¶å–å‡ºæ¥çš„æ­£åˆ™
        var errFileBox = stdout.match(regx);
        if(errFileBox == null){return;}
        var errLog = {
          filePath : '',
          errLine : []
        }, errLogLine = [];
        for(var i = 0; i<errFileBox.length; i++) {
          if(errFileBox[i].match(/^\+/)){
            if(errLog.filePath != ''){
              errLineNb.push(errLog);
            };
            errLog = {
              filePath : errFileBox[i].slice(4),
              errLine : []
            };
          }else {
            var a = errFileBox[i].split('+');
            var b = a[1].split(',');
            errLogLine.push(parseInt(b[0]));
            errLogLine.push(parseInt(b[0]) + parseInt(b[1]));
            errLog.errLine.push(errLogLine);
            errLogLine = [];
            if(i == errFileBox.length-1){
              errLineNb.push(errLog);
            }
          }
        };
        
        resolve(errLineNb);
      })
    }).then(function (errLineNb) {
      return new Promise(function(resolve, reject){
        if(errLineNb.length){
          var promiseItr = [];
          for(var i = 0; i < errLineNb.length;i++) {
           promiseItr.push(me.getEsLintResult(errLineNb[i]));
          }
        }
        Promise.all(promiseItr).then(function(){
          resolve(me.flag);
        })
      })
    }).then(function (flag) {
      if(flag){ 
        var error = {
          name: 'ESLintError',
          message: 'ä½ è¿˜æœ‰æœªè§£å†³çš„ESLinté”™è¯¯è¿˜ä¸èƒ½æäº¤ä»£ç '
        }
        throw error;
      }else{
        console.log("éªŒè¯é€šè¿‡");
      }
    }).catch(function (e) {
      console.log("ä»£ç æ£€æµ‹å®Œæ¯•,å¹¶ä¸”æ‚¨æœ‰ä»£ç è§„èŒƒé”™è¯¯ðŸ˜‚");
      process.kill(process.pid, 'SIGTERM');
    })
  } 
};
console.log("ä»£ç æ£€æµ‹ä¸­......");
var mlt = new mltLint();
mlt.lintChain()
